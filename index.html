<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Roulotte Pure</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --red: #ff3b30; --border: #222; }
        body { margin:0; background:#000; color:#fff; font-family:sans-serif; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
        .header { height:50px; display:flex; align-items:center; justify-content:center; border-bottom:1px solid var(--border); font-weight:bold; }
        .main { flex:1; display:flex; flex-direction:column; padding:10px; gap:10px; }
        .v-grid { flex:1; display:flex; flex-direction:column; gap:10px; }
        .v-box { flex:1; background:#111; border-radius:12px; border:1px solid var(--border); overflow:hidden; position:relative; }
        video { width:100%; height:100%; object-fit:cover; }
        .btn-next { width:100%; padding:20px; background:var(--red); color:#fff; border:none; border-radius:15px; font-weight:bold; font-size:18px; cursor:pointer; }
        .btn-next:disabled { background:#333; }
        #status { font-size:11px; color:#888; text-align:center; padding:5px; height: 20px; }
        @media (min-width: 800px) { .v-grid { flex-direction:row; } }
    </style>
</head>
<body>
    <div class="header">ROULOTTE LIVE</div>
    <div class="main">
        <div class="v-grid">
            <div class="v-box"><video id="me" autoplay muted playsinline></video></div>
            <div class="v-box"><video id="remote" autoplay playsinline></video></div>
        </div>
        <button id="btn-next" class="btn-next" onclick="escanear()">BUSCAR PAREJA ➔</button>
        <div id="status">Iniciando...</div>
    </div>

    <script>
        const PREFIX = "roulotte-room-";
        let myNumber = Math.floor(Math.random() * 20); // Rango de 0 a 20 para que sea más fácil encontrarse
        let myId = PREFIX + myNumber;
        let myStream, peer, actualCall;

        async function init() {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: {width: 320}, audio: true });
                document.getElementById('me').srcObject = myStream;

                peer = new Peer(myId, {
                    config: {'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }]}
                });

                peer.on('open', id => {
                    document.getElementById('status').innerText = "ESTÁS EN EL CANAL: " + myNumber;
                });

                peer.on('call', call => {
                    actualCall = call;
                    call.answer(myStream);
                    call.on('stream', s => {
                        document.getElementById('remote').srcObject = s;
                        document.getElementById('status').innerText = "¡CONECTADO!";
                    });
                });

                peer.on('error', err => {
                    if(err.type === 'id-taken') {
                        myNumber = (myNumber + 1) % 20;
                        myId = PREFIX + myNumber;
                        init();
                    }
                });
            } catch (e) { document.getElementById('status').innerText = "Cámara no disponible"; }
        }

        function escanear() {
            const btn = document.getElementById('btn-next');
            btn.disabled = true;
            btn.innerText = "ESCANEANDO...";
            document.getElementById('remote').srcObject = null;
            if(actualCall) actualCall.close();

            let target = 0;
            
            function probarSiguiente() {
                if (target >= 20) {
                    document.getElementById('status').innerText = "No hay nadie. Reintenta.";
                    btn.disabled = false;
                    btn.innerText = "BUSCAR PAREJA ➔";
                    return;
                }

                if (target === myNumber) { target++; probarSiguiente(); return; }

                document.getElementById('status').innerText = "Probando canal " + target + "...";
                let call = peer.call(PREFIX + target, myStream);
                
                let timeout = setTimeout(() => {
                    call.close();
                    target++;
                    probarSiguiente();
                }, 1500); // 1.5 segundos por canal

                call.on('stream', s => {
                    clearTimeout(timeout);
                    actualCall = call;
                    document.getElementById('remote').srcObject = s;
                    document.getElementById('status').innerText = "Conectado con canal " + target;
                    btn.disabled = false;
                    btn.innerText = "SIGUIENTE PERSONA ➔";
                });
            }
            probarSiguiente();
        }

        window.onload = init;
    </script>
</body>
</html>
