<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Roulotte Live Pro</title>
    <link rel="stylesheet" href="publico.css">
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

    <div class="header">ROULOTTE LIVE</div>
    <div class="banner-h">PUBLICIDAD SUPERIOR</div>

    <div class="main-wrapper">
        <div class="banner-v">PUBLICIDAD</div>
        
        <main class="content">
            <section class="video-side">
                <div class="v-box">
                    <span class="label">T√∫</span>
                    <video id="me" autoplay muted playsinline></video>
                    <div class="controls">
                        <button class="c-btn" onclick="toggleMic()">üé§</button>
                        <button class="c-btn" onclick="toggleCam()">üì∑</button>
                        <button class="c-btn" onclick="flipCam()">üîÑ</button>
                    </div>
                </div>
                <div class="v-box">
                    <span class="label">Pareja</span>
                    <video id="remote" autoplay playsinline></video>
                    <div class="controls">
                        <button class="c-btn" onclick="togglePiP()">üì∫</button>
                        <button class="c-btn" onclick="toggleFull()">‚õ∂</button>
                    </div>
                </div>
            </section>

            <section class="interaction-side">
                <div class="chat-container">
                    <div class="chat-msgs" id="chat"><div>Bienvenido. Haz clic en siguiente para buscar pareja.</div></div>
                    <div class="chat-input-area">
                        <input type="text" id="input-chat" placeholder="Escribe..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button class="btn-send" onclick="sendMessage()">ENVIAR</button>
                    </div>
                </div>
                <button id="btn-next" class="btn-next" onclick="buscar()">SIGUIENTE PAREJA ‚ûî</button>
            </section>
        </main>

        <div class="banner-v right">PUBLICIDAD</div>
    </div>

    <div class="banner-footer">PUBLICIDAD INFERIOR</div>
    <footer class="final-footer">¬© 2026 ROULOTTE LIVE - PIE DE P√ÅGINA</footer>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCa28DKSvgiHVtDJu2cRhGgH8FUR_9aZfQ",
            authDomain: "roulottelive.firebaseapp.com",
            databaseURL: "https://roulottelive-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "roulottelive",
            storageBucket: "roulottelive.firebasestorage.app",
            messagingSenderId: "317109934209",
            appId: "1:317109934209:web:f7c66e9159f9eb248e9580"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const myId = 'u-' + Math.floor(Math.random() * 999999);
        let myStream, peer, actualCall, dataConn, currentFacing = "user";

        async function init() {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('me').srcObject = myStream;
                startPeer();
            } catch (e) { alert("C√°mara no detectada."); }
        }

        function startPeer() {
            peer = new Peer(myId);
            peer.on('open', () => {
                db.ref('online_users/' + myId).set({ id: myId, status: 'idle' });
                db.ref('online_users/' + myId).onDisconnect().remove();
            });
            peer.on('call', call => {
                actualCall = call;
                call.answer(myStream);
                call.on('stream', s => { document.getElementById('remote').srcObject = s; });
                db.ref('online_users/' + myId).update({ status: 'busy' });
            });
            peer.on('connection', conn => {
                dataConn = conn;
                dataConn.on('data', data => {
                    const cb = document.getElementById('chat');
                    cb.innerHTML += `<div style="color:red"><b>Pareja:</b> ${data}</div>`;
                    cb.scrollTop = cb.scrollHeight;
                });
            });
        }

        function buscar() {
            const btn = document.getElementById('btn-next');
            btn.disabled = true; btn.innerText = "BUSCANDO...";
            document.getElementById('remote').srcObject = null;
            document.getElementById('chat').innerHTML = "<div>Buscando...</div>";
            if(actualCall) actualCall.close();

            db.ref('online_users/' + myId).update({ status: 'searching' });

            db.ref('online_users').once('value', snapshot => {
                const users = snapshot.val();
                let found = false;
                if(users) {
                    const targets = Object.values(users).filter(u => u.id !== myId && u.status === 'searching');
                    if(targets.length > 0) {
                        const target = targets[0];
                        actualCall = peer.call(target.id, myStream);
                        dataConn = peer.connect(target.id);
                        actualCall.on('stream', s => { 
                            document.getElementById('remote').srcObject = s; 
                            db.ref('online_users/' + myId).update({ status: 'busy' });
                        });
                        found = true;
                    }
                }
                setTimeout(() => { btn.disabled = false; btn.innerText = "SIGUIENTE PAREJA ‚ûî"; }, 3000);
            });
        }

        function sendMessage() {
            const input = document.getElementById('input-chat');
            if(dataConn && input.value) {
                dataConn.send(input.value);
                const cb = document.getElementById('chat');
                cb.innerHTML += `<div><b>T√∫:</b> ${input.value}</div>`;
                input.value = '';
                cb.scrollTop = cb.scrollHeight;
            }
        }

        function toggleMic(){ myStream.getAudioTracks()[0].enabled = !myStream.getAudioTracks()[0].enabled; }
        function toggleCam(){ myStream.getVideoTracks()[0].enabled = !myStream.getVideoTracks()[0].enabled; }
        function flipCam(){ 
            currentFacing = currentFacing === "user" ? "environment" : "user";
            navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacing } }).then(s => {
                const videoTrack = s.getVideoTracks()[0];
                if(actualCall) actualCall.peerConnection.getSenders().find(send => send.track.kind === 'video').replaceTrack(videoTrack);
                myStream.removeTrack(myStream.getVideoTracks()[0]);
                myStream.addTrack(videoTrack);
                document.getElementById('me').srcObject = myStream;
            });
        }
        function togglePiP(){ document.getElementById('remote').requestPictureInPicture(); }
        function toggleFull(){ document.getElementById('remote').parentElement.requestFullscreen(); }

        window.onload = init;
    </script>
</body>
</html>
