<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Roulotte Live Pro - Global Connect</title>
    <link rel="stylesheet" href="publico.css">
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>
<body>

    <header class="header">ROULOTTE LIVE</header>
    <div class="banner-h">PUBLICIDAD SUPERIOR</div>

    <div class="main-wrapper">
        <aside class="banner-v">PUBLICIDAD LATERAL</aside>
        
        <main class="content">
            <section class="video-side">
                <div class="v-box">
                    <span class="label">T√∫</span>
                    <video id="me" autoplay muted playsinline></video>
                    <div class="controls">
                        <button class="c-btn" title="Micro" onclick="toggleMic()">üé§</button>
                        <button class="c-btn" title="C√°mara" onclick="toggleCam()">üì∑</button>
                        <button class="c-btn" title="Girar" onclick="flipCam()">üîÑ</button>
                    </div>
                </div>
                <div class="v-box">
                    <span class="label">Pareja</span>
                    <video id="remote" autoplay playsinline></video>
                    <div class="controls">
                        <button class="c-btn" title="PiP" onclick="togglePiP()">üì∫</button>
                        <button class="c-btn" title="Pantalla Completa" onclick="toggleFull()">‚õ∂</button>
                    </div>
                </div>
            </section>

            <section class="interaction-side">
                <div class="chat-container">
                    <div class="chat-msgs" id="chat"><div>Bienvenido. Haz clic en "Siguiente" para buscar.</div></div>
                    <div class="chat-input-area">
                        <input type="text" id="input-chat" placeholder="Escribe un mensaje..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button class="btn-send" onclick="sendMessage()">ENVIAR</button>
                    </div>
                </div>
                <button id="btn-next" class="btn-next" onclick="buscar()">SIGUIENTE PAREJA ‚ûî</button>
            </section>
        </main>

        <aside class="banner-v right">PUBLICIDAD LATERAL</aside>
    </div>

    <div class="banner-footer">PUBLICIDAD INFERIOR</div>
    <footer class="final-footer">¬© 2026 ROULOTTE LIVE - PIE DE P√ÅGINA</footer>

    <script>
        // CONFIGURACI√ìN FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCa28DKSvgiHVtDJu2cRhGgH8FUR_9aZfQ",
            authDomain: "roulottelive.firebaseapp.com",
            databaseURL: "https://roulottelive-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "roulottelive",
            storageBucket: "roulottelive.firebasestorage.app",
            messagingSenderId: "317109934209",
            appId: "1:317109934209:web:f7c66e9159f9eb248e9580"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const myId = 'u-' + Math.floor(Math.random() * 999999);
        
        let myStream, peer, actualCall, dataConn, currentFacing = "user";

        // 1. Inicializar c√°mara y PeerJS
        async function init() {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 640 }, height: { ideal: 480 } }, 
                    audio: true 
                });
                document.getElementById('me').srcObject = myStream;
                startPeer();
            } catch (e) {
                alert("Error: Por favor permite el acceso a la c√°mara y micr√≥fono.");
            }
        }

        // 2. Configuraci√≥n de Peer con servidores ICE para Redes Globales (STUN/TURN)
        function startPeer() {
            const peerConfig = {
                config: {
                    'iceServers': [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { 
                            urls: 'turn:openrelay.metered.ca:443', 
                            username: 'openrelayproject', 
                            credential: 'openrelayproject' 
                        }
                    ],
                    'sdpSemantics': 'unified-plan'
                }
            };

            peer = new Peer(myId, peerConfig);

            peer.on('open', (id) => {
                db.ref('online_users/' + myId).set({ id: myId, status: 'idle', ts: Date.now() });
                db.ref('online_users/' + myId).onDisconnect().remove();
            });

            // Recibir llamada de video
            peer.on('call', call => {
                actualCall = call;
                call.answer(myStream);
                call.on('stream', s => { 
                    document.getElementById('remote').srcObject = s; 
                    db.ref('online_users/' + myId).update({ status: 'busy' });
                    document.getElementById('chat').innerHTML = "<div>¬°Pareja conectada!</div>";
                });
            });

            // Recibir conexi√≥n de datos (Chat)
            peer.on('connection', conn => {
                dataConn = conn;
                setupDataEvents();
            });

            peer.on('error', err => console.error("PeerJS Error:", err));
        }

        // 3. L√≥gica de b√∫squeda y emparejamiento
        function buscar() {
            const btn = document.getElementById('btn-next');
            btn.disabled = true;
            btn.innerText = "BUSCANDO...";
            
            // Limpieza
            document.getElementById('remote').srcObject = null;
            if(actualCall) actualCall.close();
            if(dataConn) dataConn.close();

            db.ref('online_users/' + myId).update({ status: 'searching', ts: Date.now() });

            db.ref('online_users').once('value', snapshot => {
                const users = snapshot.val();
                let found = false;

                if (users) {
                    // Filtrar usuarios buscando (que no sea yo)
                    const candidates = Object.values(users).filter(u => u.id !== myId && u.status === 'searching');
                    
                    if (candidates.length > 0) {
                        // El que lleva m√°s tiempo esperando tiene prioridad
                        const target = candidates.sort((a,b) => a.ts - b.ts)[0];
                        
                        // Sincronizaci√≥n agresiva
                        actualCall = peer.call(target.id, myStream);
                        dataConn = peer.connect(target.id);
                        
                        actualCall.on('stream', s => {
                            document.getElementById('remote').srcObject = s;
                            db.ref('online_users/' + myId).update({ status: 'busy' });
                            document.getElementById('chat').innerHTML = "<div>¬°Pareja encontrada!</div>";
                        });
                        setupDataEvents();
                        found = true;
                    }
                }

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerText = "SIGUIENTE PAREJA ‚ûî";
                }, 3000);
            });
        }

        // 4. L√≥gica del Chat
        function setupDataEvents() {
            dataConn.on('data', data => {
                const cb = document.getElementById('chat');
                cb.innerHTML += `<div style="color:var(--red)"><b>Pareja:</b> ${data}</div>`;
                cb.scrollTop = cb.scrollHeight;
            });
        }

        function sendMessage() {
            const input = document.getElementById('input-chat');
            const chatBox = document.getElementById('chat');
            if(dataConn && dataConn.open && input.value) {
                dataConn.send(input.value);
                chatBox.innerHTML += `<div><b>T√∫:</b> ${input.value}</div>`;
                input.value = '';
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        // 5. Funciones de Control de Video/Audio
        function toggleMic() {
            const audioTrack = myStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
        }

        function toggleCam() {
            const videoTrack = myStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
        }

        function flipCam() {
            currentFacing = (currentFacing === "user") ? "environment" : "user";
            navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacing } })
                .then(newStream => {
                    const videoTrack = newStream.getVideoTracks()[0];
                    if (actualCall) {
                        const sender = actualCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
                        sender.replaceTrack(videoTrack);
                    }
                    myStream.removeTrack(myStream.getVideoTracks()[0]);
                    myStream.addTrack(videoTrack);
                    document.getElementById('me').srcObject = myStream;
                });
        }

        function togglePiP() {
            if (document.pictureInPictureElement) document.exitPictureInPicture();
            else document.getElementById('remote').requestPictureInPicture();
        }

        function toggleFull() {
            const elem = document.getElementById('remote');
            if (elem.requestFullscreen) elem.requestFullscreen();
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        }

        window.onload = init;
    </script>
</body>
</html>
