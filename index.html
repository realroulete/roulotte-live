<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Roulotte Live</title>
    
    <link rel="stylesheet" href="style.css">

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <header class="header"><div class="logo">Roulotte Live</div></header>
    <div class="ad-top">PUBLICIDAD SUPERIOR</div>

    <main class="main-layout">
        <aside class="ad-side">BANNER LATERAL</aside>
        
        <div class="app-container">
            <section class="video-col">
                <div class="video-box"><video id="localVideo" autoplay muted playsinline></video></div>
                <div class="video-box"><video id="remoteVideo" autoplay playsinline></video></div>
            </section>

            <section class="chat-col">
                <div id="chat-window"><div class="msg sys">Cargando cámara...</div></div>
                <button class="btn-next" onclick="next()">SIGUIENTE PERSONA ➔</button>
            </section>
        </div>

        <aside class="ad-side">BANNER LATERAL</aside>
    </main>

    <div class="ad-bottom">PUBLICIDAD INFERIOR</div>

    <script>
        const URL = "https://bojafgtowhtxujsjgqnq.supabase.co";
        const KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJvamFmZ3Rvd2h0eHVqc2pncW5xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NzM2MjksImV4cCI6MjA4NzI0OTYyOX0.CQLuwkKsNzZ1ZjETl_t2k_Y2glmLUi83fHJCSPzB5KE";
        const db = supabase.createClient(URL, KEY, { auth: { persistSession: false } });

        let localStream, peer, myId;

        async function start() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                initPeer();
            } catch (e) {
                document.querySelector('.msg.sys').innerText = "Error: Activa la cámara en el candado de la URL.";
            }
        }

        function initPeer() {
            myId = 'rlt-' + Math.floor(Math.random() * 99999);
            peer = new Peer(myId);
            peer.on('call', call => { call.answer(localStream); call.on('stream', s => document.getElementById('remoteVideo').srcObject = s;); });
        }

        async function next() {
            // Lógica de búsqueda simplificada
            const { data } = await db.from('profiles').select('peer_id').neq('peer_id', myId).limit(1);
            if (data?.[0]) {
                const call = peer.call(data[0].peer_id, localStream);
                call.on('stream', s => document.getElementById('remoteVideo').srcObject = s);
            } else {
                await db.from('profiles').insert([{ peer_id: myId }]);
            }
        }

        window.onload = start;
    </script>
</body>
</html>
